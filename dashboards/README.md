# voiceobs Grafana Dashboards

This directory contains pre-built Grafana dashboards for visualizing voiceobs metrics and traces.

## Dashboards

### voiceobs-overview.json

**Purpose**: High-level observability across all conversations

**Panels**:
- **Latency Breakdown (ASR/LLM/TTS)** - Bar chart showing average latency for each stage
- **Latency Percentiles Over Time** - Time series showing p50, p95, p99 latencies
- **Failure Rate by Type** - Pie chart showing distribution of failure types
- **Conversation Volume** - Line chart showing conversation rate over time
- **Silence Duration Distribution** - Histogram of silence durations between turns
- **Top Failures** - Table showing the most common failures with severity

**Variables**:
- `conversation_id` - Filter by conversation ID (supports multiple selection)
- `failure_type` - Filter by failure type (supports multiple selection)
- `prometheus_datasource` - Prometheus datasource selector

### voiceobs-detailed.json

**Purpose**: Detailed view of a specific conversation

**Panels**:
- **Conversation Trace Timeline** - Full trace view showing all spans in the conversation
- **Stage Latencies by Turn** - Time series showing ASR/LLM/TTS latencies for each turn
- **Turn Details** - Table with turn information (actor, index, transcript, etc.)
- **Failures in Conversation** - Table listing all failures in the selected conversation

**Variables**:
- `conversation_id` - Select a specific conversation to view
- `prometheus_datasource` - Prometheus datasource selector
- `tempo_datasource` - Tempo datasource selector

## Quick Start

1. **Start the infrastructure**:
   ```bash
   docker-compose -f docker-compose.grafana.yml up -d
   ```

2. **Configure voiceobs** to export to OTLP:
   ```yaml
   # voiceobs.yaml
   exporters:
     otlp:
       enabled: true
       endpoint: "http://localhost:4318"
       protocol: "grpc"
   ```

3. **Import dashboards** in Grafana:
   - Open http://localhost:3000
   - Go to **Dashboards** → **Import**
   - Upload `voiceobs-overview.json` and `voiceobs-detailed.json`

## Requirements

- Grafana 10.0+
- Prometheus (for metrics)
- Tempo (for traces)
- OpenTelemetry Collector (to transform traces to metrics)

See [docs/grafana-setup.md](../docs/grafana-setup.md) for detailed setup instructions.

## Metrics Reference

The dashboards expect the following Prometheus metrics:

### Stage Metrics
- `voice_stage_duration_ms{stage_type="asr|llm|tts", conversation_id="..."}`
- `voice_stage_duration_ms_bucket{le="...", stage_type="..."}`

### Silence Metrics
- `voice_silence_duration_ms{conversation_id="..."}`
- `voice_silence_duration_ms_bucket{le="..."}`

### Failure Metrics
- `voice_failures_total{failure_type="...", severity="...", conversation_id="..."}`

### Conversation Metrics
- `voice_conversations_total{conversation_id="..."}`

These metrics are automatically generated by the OpenTelemetry Collector from trace spans. See `otel-collector-config.yaml` for the transformation configuration.

## Customization

### Adding Panels

1. Open the dashboard in Grafana
2. Click **Edit** (pencil icon)
3. Click **Add** → **Visualization**
4. Configure your query and visualization

### Modifying Queries

All panels use PromQL queries. Common patterns:

```promql
# Average latency by stage
avg(voice_stage_duration_ms) by (stage_type)

# Percentile latency
histogram_quantile(0.95, sum(rate(voice_stage_duration_ms_bucket[5m])) by (le, stage_type))

# Failure count by type
sum(voice_failures_total) by (failure_type)

# Conversation rate
rate(voice_conversations_total[5m])
```

### Filtering by Variables

Use dashboard variables in queries:

```promql
# Filter by conversation
voice_stage_duration_ms{conversation_id=~"$conversation_id"}

# Filter by failure type
voice_failures_total{failure_type=~"$failure_type"}
```

## Troubleshooting

### No Data Showing

1. **Check OTLP export**: Verify voiceobs is exporting traces
2. **Check Collector**: `docker logs otel-collector`
3. **Check Prometheus**: `curl http://localhost:9090/api/v1/query?query=voice_conversations_total`
4. **Check Tempo**: `curl http://localhost:3200/api/traces`

### Variables Not Populating

Ensure metrics exist with the expected labels. Variables query Prometheus for available label values.

### Missing Metrics

If metrics don't appear, check the OpenTelemetry Collector configuration. The collector transforms trace attributes to metrics. See `otel-collector-config.yaml`.

## Dashboard Export/Import

### Exporting

1. Open dashboard in Grafana
2. Click **Dashboard settings** (gear icon)
3. Click **JSON Model**
4. Copy the JSON

### Importing

1. Go to **Dashboards** → **Import**
2. Paste JSON or upload file
3. Configure datasources if needed
4. Click **Import**

## Version Compatibility

- **Grafana**: 10.0+
- **Prometheus**: 2.40+
- **Tempo**: 2.0+
- **OpenTelemetry Collector**: 0.80+

## Support

For issues or questions:
- Check [docs/grafana-setup.md](../docs/grafana-setup.md) for setup help
- Review [voiceobs documentation](../README.md)
- Open an issue on GitHub
